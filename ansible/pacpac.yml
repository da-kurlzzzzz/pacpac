---
- name: All hosts up-to-date
  hosts: all
  become: true

  tasks:
    - name: full system upgrade
      tags: syu
      community.general.pacman:
        update_cache: true
        upgrade: true

    - name: Filter packages that apply to this host
      ansible.builtin.set_fact:
        applicable_packages: >-
          {{ pacpac_packages |
             selectattr('machines', 'undefined') | list +
             pacpac_packages |
             selectattr('machines', 'defined') |
             selectattr('machines', 'search', ansible_facts['hostname']) | list }}

    - name: Separate AUR and native packages from the applicable list
      ansible.builtin.set_fact:
        non_aur_packages: >-
          {{ applicable_packages |
             rejectattr('aur', 'defined') |
             map(attribute='name') | list }}

    - name: install packages
      community.general.pacman:
        name: "{{ non_aur_packages }}"
        state: present

    - name: make packages explicit
      community.general.pacman:
        name: "{{ non_aur_packages }}"
        reason: explicit
        reason_for: all

    - name: Get list of explicitly installed packages
      ansible.builtin.command: pacman -Qqe
      changed_when: false
      register: explicitly_installed

    - name: Identify extra packages (installed but not in pacpac_packages for this host)
      ansible.builtin.set_fact:
        extra_packages: >
          {{ explicitly_installed.stdout_lines |
             difference(applicable_packages | map(attribute='name') | list) }}

    - name: Display extra packages (if any)
      ansible.builtin.debug:
        msg: |
          Extra packages not declared in all.yml:
          {{ extra_packages | join('\n  - ') }}
      when: extra_packages | length > 0

    - name: Append missing packages to all.yml (pure append, never reformats)
      ansible.builtin.blockinfile:
        path: "{{ playbook_dir }}/group_vars/all.yml"
        marker: "# {mark} AUTOGENERATED PACKAGES BY PACPAC (do not remove this line)"
        block: |
          {% if extra_packages | length > 0 %}
          # === Automatically added by pacpac on {{ ansible_date_time.iso8601 }} ===
          {% for pkg in extra_packages %}
            - name: {{ pkg }}
          {% endfor %}
          {% endif %}
        backup: yes
      delegate_to: localhost
      when: extra_packages | length > 0
