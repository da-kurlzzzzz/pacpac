---
- name: All hosts up-to-date
  hosts: all

  tasks:
    - name: full system upgrade
      tags: syu
      become: true
      community.general.pacman:
        update_cache: true
        upgrade: true

    - name: Filter packages that apply to this host
      ansible.builtin.set_fact:
        applicable_packages: >-
          {{ pacpac_packages |
             selectattr('machines', 'undefined') | list +
             pacpac_packages |
             selectattr('machines', 'defined') |
             selectattr('machines', 'search', ansible_facts['hostname']) | list }}

    - name: Separate AUR and native packages from the applicable list
      ansible.builtin.set_fact:
        non_aur_packages: >-
          {{ applicable_packages |
             rejectattr('aur', 'defined') |
             map(attribute='name') | list }}

    - name: install packages
      tags: pacman
      become: true
      community.general.pacman:
        name: "{{ non_aur_packages }}"
        state: present

    - name: make packages explicit
      tags: pacman
      become: true
      community.general.pacman:
        name: "{{ non_aur_packages }}"
        reason: explicit
        reason_for: all

    - name: Get list of explicitly installed packages
      ansible.builtin.command: pacman -Qqe
      changed_when: false
      register: explicitly_installed

    - name: Identify extra packages (installed but not in pacpac_packages for this host)
      ansible.builtin.set_fact:
        extra_packages: >
          {{ explicitly_installed.stdout_lines |
             difference(applicable_packages | map(attribute='name') | list) }}

    - name: Set extras to asdeps
      become: true
      community.general.pacman:
        name: "{{ extra_packages }}"
        reason: dependency
        reason_for: all
      tags: asdeps
