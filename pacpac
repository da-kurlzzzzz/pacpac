#!/bin/bash

PKGFILE="ansible/group_vars/all.yml"  # Adjust path if needed
HOSTNAME=$(hostname)
PACMAN="pacman"    # Or yay if preferred
ANSIBLE_PLAYBOOK="ansible/pacpac.yml"

# Colors for human-readable output
RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
NC="\033[0m"  # No Color

get_saved_packages() {
  yq -r ".pacpac_packages[] | select(.machines == null or (.machines | index(\"$HOSTNAME\"))) | .name" "$PKGFILE"
}

get_installed_packages() {
  $PACMAN -Qqe
}

show_diff() {
  saved=$(get_saved_packages)
  installed=$(get_installed_packages)
  extras=$(comm -23 <(sort <<< "$installed") <(sort <<< "$saved"))
  missing=$(comm -13 <(sort <<< "$installed") <(sort <<< "$saved"))
  echo -e "${YELLOW}Extras (installed not in list):${NC}"
  echo -e "$extras" | column -x
  echo -e "${YELLOW}Missing (in list not installed):${NC}"
  echo -e "$missing" | column -x
}

add_extras_to_yml() {
  extras="$1"
  if [ -n "$extras" ]; then
    echo "# BEGIN AUTOGENERATED PACKAGES BY PACPAC $(date +%c)" >> "$PKGFILE"
    aur="$($PACMAN -Qqm $extras)"
    native="$($PACMAN -Qqn $extras)"
    for p in $native
    do
        echo "  - name: $p" >> "$PKGFILE"
    done
    for p in $aur
    do
        echo "  - name: $p" >> "$PKGFILE"
        echo "    aur: true" >> "$PKGFILE"
    done
    echo "# END AUTOGENERATED PACKAGES BY PACPAC" >> "$PKGFILE"
    echo -e "${GREEN}Added extras to $PKGFILE. Review manually.${NC}"
  fi
}

remove_orphans() {
  orphans=$($PACMAN -Qqdt)
  if [ -n "$orphans" ]; then
    echo -e "${RED}Orphans:${NC} $orphans"
    echo "$orphans" | sudo $PACMAN -Rs -
  fi
}

run_playbook() {
    pushd "$(dirname "$ANSIBLE_PLAYBOOK")"
    ansible-playbook --ask-become-pass "$(basename "$ANSIBLE_PLAYBOOK")" "$@"
    popd
}

ask() {
    local prompt="$1"
    local response
    while true; do
        read -p "${GREEN}$prompt ${YELLOW}[Y/n]${NC}: " response
        case "$response" in
            ""|[Yy]*) return 0 ;;
            [Nn]*) return 1 ;;
            *) echo "Please answer y or n (or press Enter for yes)." ;;
        esac
    done
}

interactive_menu() {
    echo -e "${GREEN}Let me help you with pacman package management${NC}"
    show_diff
    ask "Install missing packages? [Y/n]" && run_playbook --skip-tags asdeps
    show_diff
    ask "Add extra packages to package list? [Y/n]" && add_extras_to_yml "$(comm -23 <(sort <<< "$(get_installed_packages)") <(sort <<< "$(get_saved_packages)"))"
    show_diff
    ask "Prepare extra packages for removal? [Y/n]" && run_playbook --skip-tags install
    show_diff
    ask "Remove orphans? [Y/n]" && remove_orphans
}

interactive_menu
