#!/bin/bash

PKGFILE="ansible/group_vars/all.yml"  # Adjust path if needed
HOSTNAME=$(hostname)
PACMAN="pacman"    # Or yay if preferred
ANSIBLE_PLAYBOOK="ansible-playbook pacpac.yml"

# Colors for human-readable output
GREEN="\033[1;32m"
RED="\033[1;31m"
YELLOW="\033[1;33m"
NC="\033[0m"  # No Color

get_saved_packages() {
  yq -r ".pacpac_packages[] | select(.machines == null or (.machines | index(\"$HOSTNAME\"))) | .name" "$PKGFILE"
}

get_installed_packages() {
  $PACMAN -Qqe
}

show_diff() {
  saved=$(get_saved_packages)
  installed=$(get_installed_packages)
  extras=$(comm -23 <(sort <<< "$installed") <(sort <<< "$saved"))
  missing=$(comm -13 <(sort <<< "$installed") <(sort <<< "$saved"))
  echo "Extras (installed not in list):"
  echo "$extras" | column -c 80
  echo "Missing (in list not installed):"
  echo "$missing" | column -c 80
}

add_extras_to_yml() {
  extras="$1"
  if [ -n "$extras" ]; then
    echo "# BEGIN AUTOGENERATED PACKAGES BY PACPAC $(date +%c)" >> "$PKGFILE"
    aur="$($PACMAN -Qqm $extras)"
    native="$($PACMAN -Qqn $extras)"
    for p in $native
    do
        echo "  - name: $p" >> "$PKGFILE"
    done
    for p in $aur
    do
        echo "  - name: $p" >> "$PKGFILE"
        echo "    aur: true" >> "$PKGFILE"
    done
    echo "# END AUTOGENERATED PACKAGES BY PACPAC" >> "$PKGFILE"
    echo "Added extras to $PKGFILE. Review manually."
  fi
}

remove_orphans() {
  orphans=$($PACMAN -Qqdt)
  if [ -n "$orphans" ]; then
    echo "Orphans: $orphans"
    read -p "Remove? [y/N] " yn
    [ "$yn" = "y" ] && echo "$orphans" | sudo $PACMAN -Rs -
  fi
}

interactive_menu() {
  while true; do
    echo "1. Show diff"
    echo "2. Install missing (via Ansible)"
    echo "3a. Add extras to list"
    echo "3b. Set extras as deps (via Ansible)"
    echo "4. Remove orphans"
    echo "q. Quit"
    read -p "Choice: " choice
    case $choice in
      1) show_diff ;;
      2) $ANSIBLE_PLAYBOOK ;;
      3a) add_extras_to_yml "$(comm -23 <(sort <<< "$(get_installed_packages)") <(sort <<< "$(get_saved_packages)"))" ;;
      3b) $ANSIBLE_PLAYBOOK --tags asdeps ;;
      4) remove_orphans ;;
      q) exit ;;
    esac
  done
}

interactive_menu
