#!/bin/bash

PKGFILE="ansible/group_vars/all.yml"  # Adjust path if needed
HOSTNAME=$(hostname)
PACMAN="pacman"    # Or yay if preferred
ANSIBLE_PLAYBOOK="ansible/pacpac.yml"

# Colors for human-readable output
GREEN="\033[1;32m"
RED="\033[1;31m"
YELLOW="\033[1;33m"
NC="\033[0m"  # No Color

get_saved_packages() {
  yq -r ".pacpac_packages[] | select(.machines == null or (.machines | index(\"$HOSTNAME\"))) | .name" "$PKGFILE"
}

get_installed_packages() {
  $PACMAN -Qqe
}

show_diff() {
  saved=$(get_saved_packages)
  installed=$(get_installed_packages)
  extras=$(comm -23 <(sort <<< "$installed") <(sort <<< "$saved"))
  missing=$(comm -13 <(sort <<< "$installed") <(sort <<< "$saved"))
  echo -e "${YELLOW}Extras (installed not in list):${NC}"
  echo -e "$extras" | column -x
  echo -e "${YELLOW}Missing (in list not installed):${NC}"
  echo -e "$missing" | column -x
}

add_extras_to_yml() {
  extras="$1"
  if [ -n "$extras" ]; then
    echo "# BEGIN AUTOGENERATED PACKAGES BY PACPAC $(date +%c)" >> "$PKGFILE"
    aur="$($PACMAN -Qqm $extras)"
    native="$($PACMAN -Qqn $extras)"
    for p in $native
    do
        echo "  - name: $p" >> "$PKGFILE"
    done
    for p in $aur
    do
        echo "  - name: $p" >> "$PKGFILE"
        echo "    aur: true" >> "$PKGFILE"
    done
    echo "# END AUTOGENERATED PACKAGES BY PACPAC" >> "$PKGFILE"
    echo -e "${GREEN}Added extras to $PKGFILE. Review manually.${NC}"
  fi
}

remove_orphans() {
  orphans=$($PACMAN -Qqdt)
  if [ -n "$orphans" ]; then
    echo -e "${RED}Orphans:${NC} $orphans"
    echo "$orphans" | sudo $PACMAN -Rs -
  fi
}

run_playbook() {
    pushd "$(dirname "$ANSIBLE_PLAYBOOK")"
    ansible-playbook --ask-become-pass "$(basename "$ANSIBLE_PLAYBOOK")" "$@"
    popd
}

interactive_menu() {
  while true; do
    echo -e "1. Show diff"
    echo -e "2. Install missing (via Ansible)"
    echo -e "3a. Add extras to list"
    echo -e "3b. Set extras as deps (via Ansible)"
    echo -e "4. Remove orphans"
    echo -e "q. Quit"
    read -p "Choice: " choice
    case $choice in
      1) show_diff ;;
      2) run_playbook --skip-tags asdeps ;;
      3a) add_extras_to_yml "$(comm -23 <(sort <<< "$(get_installed_packages)") <(sort <<< "$(get_saved_packages)"))" ;;
      3b) run_playbook --skip-tags install ;;
      4) remove_orphans ;;
      q) exit ;;
    esac
  done
}

interactive_menu
